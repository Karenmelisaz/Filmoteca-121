# -*- coding: utf-8 -*-
"""reservas

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xO6RvuBXgjxqEbdy7qZjlo5hEBcUwUAd
"""

import csv
import uuid
from datetime import datetime
from datos import RES_FILE, TARIFAS
from usuarios import buscar_usuario
from funciones import leer_funciones
from cartelera import mostrar_cartelera
from asientos import cargar_asientos, inicializar_asientos, guardar_asientos, mostrar_asientos
from utilidades import solicitar_documento_input

def leer_reservas():
    with open(RES_FILE, newline="", encoding="utf-8") as f:
        return list(csv.DictReader(f))

def registrar_reserva():
    print("\n=== REGISTRAR RESERVA ===")

    doc = solicitar_documento_input("Documento del usuario: ")
    user = buscar_usuario(doc)

    if not user:
        print("⚠️ Usuario no registrado.")
        return

    mostrar_cartelera()
    fid = input("\nIngrese ID de función (Ej: F01): ").strip().upper()

    func = next((f for f in leer_funciones() if f["function_id"] == fid), None)
    if not func:
        print("⚠️ ID inválido.")
        return

    inicializar_asientos(fid, func["disponibles"])
    mostrar_asientos(fid)
    mapa = cargar_asientos(fid)

    while True:
        asiento = input("Seleccione asiento (Ej: A7): ").upper()
        sel = next((s for s in mapa if s["asiento"] == asiento), None)

        if not sel:
            print("❌ Asiento inválido.")
            continue

        if sel["estado"] == "X":
            print("❌ Ocupado. Elija otro.")
            continue

        sel["estado"] = "X"
        break

    guardar_asientos(fid, mapa)
    precio = TARIFAS[user["vinculo"]]
    rid = str(uuid.uuid4())[:8]
    fecha = datetime.now().isoformat()

    with open(RES_FILE, "a", newline="", encoding="utf-8") as f:
        csv.writer(f).writerow([rid, doc, fid, asiento, precio, fecha])

    print("\n===== FACTURA =====")
    print("Reserva ID:", rid)
    print("Usuario:", user["nombre"], user["apellido"])
    print("Función:", fid)
    print("Asiento:", asiento)
    print("Valor pagado: $", precio)
    print("----------------------------")